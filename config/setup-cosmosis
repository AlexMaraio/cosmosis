# This file must be sourced, so that it can establish the appropriate
# environment for a development session.
# Note: this currently only supports bash

# Detect whether CosmoSIS is already set up; if so, do not repeat the
# setup.
cosmo_cmd=$(type cosmosis 2> /dev/null)
if [ ! -z "$cosmo_cmd" ]
then
  echo CosmoSIS is already set up.
  return 0
fi

# detect COSMOSIS_SRC_DIR
if [ -z "$COSMOSIS_SRC_DIR" ]
then
  cosmosis_dir=$( (builtin cd $( dirname ${BASH_SOURCE[0]}); /bin/pwd) )
  cosmosis_dir=${cosmosis_dir%/config}
  export COSMOSIS_SRC_DIR="$cosmosis_dir"
fi

product_db=`cat $COSMOSIS_SRC_DIR/config/ups`
if [ ! -f "$product_db/setups" ]
then
    echo "The directory $product_db does not appear to contain the UPS products."
    return 1
fi

# initialize UPS
source $product_db/setups
if [ -z "$PRODUCTS" ]
then
    echo "The setup of the UPS system has failed; please ask a local expert for assistance."
    return 1
fi

# Set the library path appropriate for our flavor.
libdir=${COSMOSIS_SRC_DIR}/cosmosis/datablock
flavor=$(ups flavor -1)
if [ "$flavor" = "Darwin64bit" ]
then
    export DYLD_LIBRARY_PATH="${libdir}${DYLD_LIBRARY_PATH:+:${DYLD_LIBRARY_PATH}}"
else
    export LD_LIBRARY_PATH="${libdir}${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"
fi

export PATH=${COSMOSIS_SRC_DIR}/bin:$PATH

# On OS X, we use the Anaconda python we have installed.
if [ "$flavor" == "Darwin64bit" ]
then
  export PATH=${COSMOSIS_SRC_DIR}/conda/bin:$PATH
fi

export PYTHONPATH=${COSMOSIS_SRC_DIR}

# don't allow this as it probably causes problems
# during installation. Maybe support it later as
# an advanced feature
#
# allow user to override our PYTHONUSERBASE
#if [ -z "$PYTHONUSERBASE" ]
#then
export PYTHONUSERBASE=${COSMOSIS_SRC_DIR}
#fi

# setup UPS packages
# We do not use the Python UPS products on OS X.
setup -B gcc v4_9_2

if [ "$flavor" != "Darwin64bit" ]
then
  setup -B scipy v0_13_0b -q +e5:+prof
  setup -B pyfits v3_2a -q +e5:+prof
  setup -B pyyaml v3_11
fi

setup -B gsl v1_16 -q +prof

setup -B fftw v3_3_3 -q +prof 2> /dev/null
status=$?

if [[ $status != 0 ]]
then
setup -B fftw v3_3_4   -q +prof
fi

setup -B cfitsio v3_35_0 -q +prof 2> /dev/null
status=$?

if [[ $status != 0 ]]
then
setup -B cfitsio v3_37_0   -q +prof
fi


if [ "$flavor" == "Darwin64bit" ]
then
export LAPACK_LIB=.
else
setup -B lapack v3_4_2 -q +e5:+prof
fi

if [ -d "$SETUPS_DIR/planckdata/v1_1" ]
then
	setup -B planckdata v1_1
fi

if [ -d "$SETUPS_DIR/wmapdata/v5_00" ]
then
	setup -B wmapdata v5_00
fi

if [ -d "$SETUPS_DIR/minuit2/v5_28_0" ]
then
	setup -B minuit2 v5_28_0 -q +e5:+prof
fi

#if [ "$flavor" = "Darwin64bit" ]
mpich_qualified_version="mpich v3_1 -q +e5:+prof"
if ups exist $mpich_qualified_version
then
    setup -B $mpich_qualified_version
fi

export PS1="(cosmosis) ${PS1:+${PS1}}"
