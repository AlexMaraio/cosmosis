if type "cosmosis" &> /dev/null
then
  echo CosmoSIS and conda are already set up.
  return 0
fi

if [ -z "$1" ]
then
  CONDA_ENV_DIR=./conda_env    
else
  CONDA_ENV_DIR=$1
fi


if [ ! -d "${CONDA_ENV_DIR}" ]
then
  echo "Creating conda environment"
  conda create --yes  -p ${CONDA_ENV_DIR} -c conda-forge numpy scipy matplotlib future configparser astropy scikit-learn emcee==2.2.1 cfitsio fitsio cython pyyaml six kombine gsl minuit2 mpi4py fftw openblas cxx-compiler fortran-compiler pytest pybind11
fi

OS=$(uname -s)

eval "$(conda shell.bash hook)"
conda activate ${CONDA_ENV_DIR}



export CONDA_INCLUDE_DIR=${CONDA_PREFIX}/include
export CONDA_LIB_DIR=${CONDA_PREFIX}/lib
export COSMOSIS_SRC_DIR=${PWD}

# Minuit2
export MINUIT2_INC=${CONDA_INCLUDE_DIR}/Minuit2
export MINUIT2_LIB=${CONDA_LIB_DIR}

# The gnu science library
export GSL_INC=${CONDA_INCLUDE_DIR}
export GSL_LIB=${CONDA_LIB_DIR}

# The cfitsio FITS library
export CFITSIO_INC=${CONDA_INCLUDE_DIR}
export CFITSIO_LIB=${CONDA_LIB_DIR}

# The fftw3 Fourier transform library
export FFTW_LIBRARY=${CONDA_LIB_DIR}
export FFTW_INCLUDE_DIR=${CONDA_INCLUDE_DIR}

# The lapack linear algebra package
export LAPACK_LINK="-llapack -lblas"

# Darwin does not use LD_LIBRARY_PATH, so we set it only for Linux
if [ "$OS" = "Linux" ]
then
  CSL=${COSMOSIS_SRC_DIR}/cosmosis-standard-library
  export LD_LIBRARY_PATH=${COSMOSIS_SRC_DIR}/cosmosis/datablock:${CSL}/likelihood/planck2015/plc-2.0/lib:${CFITSIO_LIB}:${CSL}/boltzmann/isitgr/camb_Jan12_isitgr:${CSL}/boltzmann/mgcamb/camb_Jan12_mgcamb:${CSL}/likelihood/fgas/src${LD_LIBRARY_PATH+:$LD_LIBRARY_PATH}
  export COSMOSIS_OMP=1
fi

export PYTHONPATH=${COSMOSIS_SRC_DIR}:${PYTHONPATH}
export PATH=${COSMOSIS_SRC_DIR}/bin:${PATH}

# Our default compiler suite is GCC, so we have to set the compilers only on Darwin.
if [ $OS = "Darwin" ]
then
  export CXX=clang++
  export CC=clang
  export FC=gfortran
  export MPIFC=mpifort
  export COSMOSIS_ALT_COMPILERS=1
fi
