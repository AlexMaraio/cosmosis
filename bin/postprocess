#!/usr/bin/env python
from cosmosis.postprocessing.postprocess import postprocessor_for_sampler
from cosmosis.runtime.config import Inifile
import sys
import argparse


parser = argparse.ArgumentParser(description="Post-process cosmosis output")
parser.add_argument("inifile")
mcmc=parser.add_argument_group(title="MCMC", description="Options for MCMC-type samplers")
mcmc.add_argument("--burn", default=0.0, type=float, help="Fraction or number of samples to burn at the start")
mcmc.add_argument("--thin", default=1, type=int, help="Keep every n'th sampler in MCMC")

general=parser.add_argument_group(title="General", description="General options for controlling postprocessing")
general.add_argument("-o","--outdir", default=".", help="Output directory for all generated files")
general.add_argument("-p","--prefix", default="", help="Prefix for all generated files")
general.add_argument("--more-latex", default="", help="Load an additional latex file to the default")
general.add_argument("--no-latex", action='store_true', help="Do not use latex-style labels, just use the text")

plots=parser.add_argument_group(title="Plotting", description="Plotting options")
plots.add_argument("--no-plots", action='store_true', help="Do not make any default plots")
plots.add_argument("-f", "--file-type", default="png", help="Filename suffix for plots")
plots.add_argument("--no-smooth", dest='smooth', default=True, action='store_false', help="Do not smooth grid plot joint constraints")
plots.add_argument("--n-kde", default=100, type=int, help="Number of KDE smoothing points per dimension to use for MCMC 2D curves. Reduce to speed up, but can make plots look worse.")
plots.add_argument("--factor-kde", default=2.0, type=float, help="Smoothing factor for MCMC plots.  More makes plots look better but can smooth out too much.")
plots.add_argument("--no-fill", dest='fill', default=True, action='store_false', help="Do not fill in 2D constraint plots with color")



def main(args):
	#Read the command line arguments and load the
	#ini file that created the run
	args = parser.parse_args(args)
	ini_filename = args.inifile
	ini = Inifile(ini_filename)

	#Determine the sampler and get the class
	#designed to postprocess the output of that sampler
	sampler = ini.get("runtime", "sampler")
	processor_class = postprocessor_for_sampler(sampler)

	#We do not know how to postprocess everything.
	if processor_class is None:
		print "I do not know how to postprocess output from the %s sampler"%sampler
		return

	#Create and run the postprocessor
	processor = processor_class(ini, **vars(args))
	processor.run()
	#At some point we might run the processor on multiple chains
	#in that case we would call run more than once
	#and then finalize at the end
	processor.finalize()

if __name__=="__main__":
	main(sys.argv[1:])
